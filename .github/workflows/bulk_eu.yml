name: OnePlus Bulk OTA Archiver EU

on:
  workflow_dispatch:

jobs:
  process_otas:
    runs-on: ubuntu-latest
    steps:
      # -------------------------------------------------
      # 1. CHECKOUT
      # -------------------------------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v3

      # -------------------------------------------------
      # 2. FREE DISK SPACE
      # -------------------------------------------------
      - name: üßπ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      # -------------------------------------------------
      # 3. INSTALL TOOLS
      # -------------------------------------------------
      - name: üì¶ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full

      # -------------------------------------------------
      # 4. PROCESS OTAS (THE LOOP)
      # -------------------------------------------------
      - name: üîÑ Process OTAs Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          # -------------------------------------------------------
          # CONFIGURATION: LIST YOUR OTAS HERE
          # Format: "VERSION|URL"
          # -------------------------------------------------------
          declare -a OTAS=(
            "16.0.1.301|https://gauss-compota-c-fr.allawnofs.com/remove-e8681a84889f228b955e83c2e1bc6407/g-8e6c201cbb7830277671f83420eea503/component-ota/25/11/17/e32f5bfe903d4e79863988d7ea7d9b2c.zip?sign=a2c2a641590f8c19e3120158677adcf8&t=6937d16f&x-oss-signature=FPcPzLkdOX4Xyn4iDyvp%2FFb%2F97K6cc5EY%2BPiS6gWR1o%3D&x-oss-signature-version=OSS2&x-oss-expires=1765267575&x-oss-access-key-id=LTAI5t7LQqPWs3796pRv6Avx"

          # -------------------------------------------------------
          # START LOOP
          # -------------------------------------------------------
          count=0
          total=${#OTAS[@]}
          
          for item in "${OTAS[@]}"; do
            count=$((count+1))
            
            # Split string
            VERSION="${item%%|*}"
            URL="${item##*|}"
            
            TAG="CPH2663EEA-${VERSION}"
            BASE_NAME="CPH2663EEA-${VERSION}"
            
            echo "---------------------------------------------------"
            echo "üöÄ Processing [$count/$total]: $TAG"
            echo "---------------------------------------------------"

            # Check if Release exists
            if gh release view "$TAG" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Release $TAG already exists. Skipping..."
              continue
            fi

            # --- DM: DOWNLOAD STARTED ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚¨áÔ∏è *Downloading Started EU * ($count/$total)%0AVersion: \`$VERSION\`" \
              -d parse_mode="Markdown" > /dev/null

            # 2. Download
            echo "‚¨áÔ∏è Downloading..."
            aria2c "$URL" -x16 -s16 -k1M -o ota.zip -q

            # --- DM: ZIPPING ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚úÇÔ∏è *Zipping/Splitting...*" \
              -d parse_mode="Markdown" > /dev/null

            # 3. Split
            echo "‚úÇÔ∏è Splitting..."
            mkdir -p split_output
            7z a -t7z -mx=0 -v1900m "split_output/${BASE_NAME}.7z" "ota.zip"

            # 4. Create Release
            echo "üì¶ Creating GitHub Release..."
            
            # --- NEW RELEASE NOTES FORMAT ---
            NOTES="**Region:** EUROPE ( CPH2663EEA ) "$'\n'"**Version:** ${VERSION} üì±"$'\n'"**Type:** Official OTA üì¶"$'\n\n'"**BOOT & INIT_BOOT of this ${VERSION} can be found here :** https://t.me/boot_imgs_nord4/2"
            
            gh release create "$TAG" -t "OnePlus OTA - ${VERSION}" -n "$NOTES"

            # 5. Upload Loop (With Start/Done DMs)
            echo "üì§ Uploading assets..."
            part_num=0
            
            # Enable nullglob in case of weird file matches
            shopt -s nullglob
            
            for f in split_output/*; do
               part_num=$((part_num+1))
               fname=$(basename "$f")
               
               # --- DM: UPLOAD START ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="üöÄ *Upload Started*: $fname" \
                -d parse_mode="Markdown" > /dev/null

               # Upload (Force overwrite)
               gh release upload "$TAG" "$f" --clobber
               
               # --- DM: UPLOAD DONE ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="‚úÖ *Upload Done*: $fname" \
                -d parse_mode="Markdown" > /dev/null
            done

            # 6. Cleanup
            echo "üßπ Cleaning up..."
            rm -rf ota.zip split_output
            
            echo "‚úÖ Done with $TAG"
          done
          
          echo "üéâ All tasks finished!"

      # -------------------------------------------------
      # 5. FAILURE NOTIFICATION
      # -------------------------------------------------
      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚ùå *Pipeline FAILED!* Check GitHub Actions logs for details." \
          -d parse_mode="Markdown"
