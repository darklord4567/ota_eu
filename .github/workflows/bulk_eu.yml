name: OnePlus Bulk OTA Archiver EU

on:
  workflow_dispatch:

jobs:
  process_otas:
    runs-on: ubuntu-latest
    steps:
      # -------------------------------------------------
      # 1. CHECKOUT
      # -------------------------------------------------
      - name: üì• Checkout Repo
        uses: actions/checkout@v3

      # -------------------------------------------------
      # 2. FREE DISK SPACE
      # -------------------------------------------------
      - name: üßπ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo docker system prune -af || true
          sudo apt-get autoremove -y
          sudo apt-get clean
          df -h

      # -------------------------------------------------
      # 3. INSTALL TOOLS
      # -------------------------------------------------
      - name: üì¶ Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full

      # -------------------------------------------------
      # 4. PROCESS OTAS (THE LOOP)
      # -------------------------------------------------
      - name: üîÑ Process OTAs Loop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          # -------------------------------------------------------
          # CONFIGURATION: LIST YOUR OTAS HERE
          # Format: "VERSION|URL"
          # -------------------------------------------------------
          declare -a OTAS=(
            "14.1.0.320|https://gauss-opexcostmanual-eu.allawnofs.com/remove-833308a2c2e04a4b8a4316745b04a7ff/component-ota/24/07/19/6d9a8b2fcaab46cf967cc9be71d067c4.zip"
            "14.1.0.401|https://gauss-opexcostmanual-eu.allawnofs.com/remove-85330d30a8447f7a257a846590eecd4e/component-ota/24/08/20/dd2f865d351d4c49b231b20adf5f48ce.zip"
            "14.1.0.603|https://gauss-opexcostmanual-eu.allawnofs.com/remove-5204a88a33486514ee1f58580b116cde/component-ota/24/10/11/a2ef5d9ca66e40f1a284f91418f4c040.zip"
            "14.1.0.605|https://gauss-opexcostmanual-eu.allawnofs.com/remove-8dbf4fe2dba8815dbbcb3d9bcee33d0f/component-ota/24/11/13/7ece91f468db494bb683b87901ce2597.zip"
            "15.0.0.401|https://gauss-opexcostmanual-eu.allawnofs.com/remove-26db91c1831737b713824bf234bda276/component-ota/24/12/26/831468d1bb344f26b6d8f349819b3978.zip"
            "15.0.0.500|https://gauss-opexcostmanual-sg.allawnofs.com/remove-8effbe7f2f3f02da978da0bab32c1ff3/component-ota/25/01/21/0e094e9b4a2547e58f358f5badc463ef.zip"
            "15.0.0.601|https://gauss-opexcostmanual-sg.allawnofs.com/remove-9dce8095efca564e91f027be8c3da473/component-ota/25/02/26/98577420dedf4b1ba27204de888a8cb2.zip"
            "15.0.0.702|https://gauss-opexcostmanual-sg.allawnofs.com/remove-1a16bcb9d8c4d44b7557e1066b1f2100/component-ota/25/04/07/a08b6c26f6c84a2daae6dac9e7b17ae3.zip"
            "15.0.0.1002|https://gauss-opexcostmanual-eu.allawnofs.com/remove-a1eff8e4fdfbd65cbfe14375c2397540/component-ota/25/06/24/a1eb00ab8aa54aed9539d5d367f3097e.zip"
            "15.0.0.1201|https://gauss-opexcostmanual-eu.allawnofs.com/remove-c03f2d5f18fe0c881a5e92423f741484/component-ota/25/08/11/3f44bd86573545cd821d32b7a5d5e121.zip"
            "15.0.0.1203|https://gauss-opexcostmanual-eu.allawnofs.com/remove-fb166b6ae7ee5a4c9b02f78dd46c8f05/component-ota/25/08/26/41d2f7b27e2340b2ab0d3b2ae54ec860.zip"
            "15.0.0.1301|https://gauss-opexcostmanual-eu.allawnofs.com/remove-4e6bf4ac4359329010d016ecb48f351d/component-ota/25/10/14/2613911822dd4a6cb6e4c78f6cb31938.zip"
          )

          # -------------------------------------------------------
          # START LOOP
          # -------------------------------------------------------
          count=0
          total=${#OTAS[@]}
          
          for item in "${OTAS[@]}"; do
            count=$((count+1))
            
            # Split string
            VERSION="${item%%|*}"
            URL="${item##*|}"
            
            TAG="CPH2663EEA-${VERSION}"
            BASE_NAME="CPH2663EEA-${VERSION}"
            
            echo "---------------------------------------------------"
            echo "üöÄ Processing [$count/$total]: $TAG"
            echo "---------------------------------------------------"

            # Check if Release exists
            if gh release view "$TAG" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Release $TAG already exists. Skipping..."
              continue
            fi

            # --- DM: DOWNLOAD STARTED ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚¨áÔ∏è *Downloading Started EU * ($count/$total)%0AVersion: \`$VERSION\`" \
              -d parse_mode="Markdown" > /dev/null

            # 2. Download
            echo "‚¨áÔ∏è Downloading..."
            aria2c "$URL" -x16 -s16 -k1M -o ota.zip -q

            # --- DM: ZIPPING ---
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
              -d chat_id="$TG_DM" \
              -d text="‚úÇÔ∏è *Zipping/Splitting...*" \
              -d parse_mode="Markdown" > /dev/null

            # 3. Split
            echo "‚úÇÔ∏è Splitting..."
            mkdir -p split_output
            7z a -t7z -mx=0 -v1900m "split_output/${BASE_NAME}.7z" "ota.zip"

            # 4. Create Release
            echo "üì¶ Creating GitHub Release..."
            
            # --- NEW RELEASE NOTES FORMAT ---
            NOTES="**Region:** EUROPE ( CPH2663EEA ) "$'\n'"**Version:** ${VERSION} üì±"$'\n'"**Type:** Official OTA üì¶"$'\n\n'"**BOOT & INIT_BOOT of this ${VERSION} can be found here :** https://t.me/boot_imgs_nord4/2"
            
            gh release create "$TAG" -t "OnePlus OTA - ${VERSION}" -n "$NOTES"

            # 5. Upload Loop (With Start/Done DMs)
            echo "üì§ Uploading assets..."
            part_num=0
            
            # Enable nullglob in case of weird file matches
            shopt -s nullglob
            
            for f in split_output/*; do
               part_num=$((part_num+1))
               fname=$(basename "$f")
               
               # --- DM: UPLOAD START ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="üöÄ *Upload Started*: $fname" \
                -d parse_mode="Markdown" > /dev/null

               # Upload (Force overwrite)
               gh release upload "$TAG" "$f" --clobber
               
               # --- DM: UPLOAD DONE ---
               curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
                -d chat_id="$TG_DM" \
                -d text="‚úÖ *Upload Done*: $fname" \
                -d parse_mode="Markdown" > /dev/null
            done

            # 6. Cleanup
            echo "üßπ Cleaning up..."
            rm -rf ota.zip split_output
            
            echo "‚úÖ Done with $TAG"
          done
          
          echo "üéâ All tasks finished!"

      # -------------------------------------------------
      # 5. FAILURE NOTIFICATION
      # -------------------------------------------------
      - name: ‚ùå DM ‚Äî Pipeline Failed
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_DM: ${{ secrets.TG_DM }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
          -d chat_id="$TG_DM" \
          -d text="‚ùå *Pipeline FAILED!* Check GitHub Actions logs for details." \
          -d parse_mode="Markdown"
